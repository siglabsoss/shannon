/******************************************************************************
* Copyright 2014 PopWi Technology Group, Inc. (PTG)
*
* This file is proprietary and exclusively owned by PTG or its associates.
* This document is protected by international and domestic patents where
* applicable. All rights reserved.
*
******************************************************************************/

#include <assert.h>
#include <stddef.h>
#include <cstring>

#include <vector>

#include <cmath>

#include "core/ldpc.hpp"

using std::make_pair;
using std::pair;
using std::string;
using std::vector;
using namespace std;


namespace pop
{

//FIXME: add simple routing to not send messages back to sender during a send_down()

LDPC::LDPC(short** Hin, unsigned u1, unsigned u2)
{
	// setup H, our code matrix
	// h_rows can never be less than 2 due to an optimization
//	int h_rows = 3;
//	int h_cols = 7;
//
//	short H[h_rows][h_cols];


	// fill H with 0's
	memset(H, 0, sizeof(H[0][0]) * h_rows * h_cols);

	// set 1's

	// row by row

	H[0][0] = 0;//     0     0     0     1     0     0     0     0     0     0     1     0     0     0     0
	H[0][1] = 0;//     0     0     1     0     0     1     0     0     1     0     0     1     0     0     0
	H[0][2] = 0;//     0     0     0     0     0     1     0     0     0     0     0     0     0     0     1
	H[0][3] = 1;//     1     0     0     0     1     0     1     0     0     1     0     1     0     0     0
	H[0][4] = 0;//     0     1     1     0     0     0     0     0     0     1     1     1     0     0     0
	H[0][5] = 1;//     0     0     0     0     0     0     1     1     0     0     1     0     0     0     0
	H[0][6] = 0;//     1     0     0     0     1     0     0     0     1     0     0     0     1     0     1
	H[0][7] = 0;//     1     0     1     0     1     1     0     0     1     0     0     0     0     1     0
	H[0][8] = 1;//     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[0][9] = 0;//     1     0     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[0][10] = 0;//     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[0][11] = 0;//     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0
	H[0][12] = 0;//     0     0     0     1     0     0     0     0     0     0     0     0     0     0     0
	H[0][13] = 0;//     0     0     0     0     1     0     0     0     0     0     0     0     0     0     0
	H[0][14] = 0;//     0     0     0     0     0     1     0     0     0     0     0     0     0     0     0
	H[0][15] = 0;//     0     0     0     0     0     0     1     0     0     0     0     0     0     0     0
	H[0][16] = 0;//     0     0     0     0     0     0     0     1     0     0     0     0     0     0     0
	H[0][17] = 0;//     0     0     0     0     0     0     0     0     1     0     0     0     0     0     0
	H[0][18] = 0;//     0     0     0     0     0     0     0     0     0     1     0     0     0     0     0
	H[0][19] = 0;//     0     0     0     0     0     0     0     0     0     0     1     0     0     0     0
	H[0][20] = 0;//     0     0     0     0     0     0     0     0     0     0     0     1     0     0     0
	H[0][21] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     1     0     0
	H[0][22] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     0     1     0
	H[0][23] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1

	H[1][0] = 0;//     0     0     1     0     0     0     0     0     0     1     0     0     0     0
	H[1][1] = 0;//     0     1     0     0     1     0     0     1     0     0     1     0     0     0
	H[1][2] = 0;//     0     0     0     0     1     0     0     0     0     0     0     0     0     1
	H[1][3] = 1;//     0     0     0     1     0     1     0     0     1     0     1     0     0     0
	H[1][4] = 0;//     1     1     0     0     0     0     0     0     1     1     1     0     0     0
	H[1][5] = 0;//     0     0     0     0     0     1     1     0     0     1     0     0     0     0
	H[1][6] = 1;//     0     0     0     1     0     0     0     1     0     0     0     1     0     1
	H[1][7] = 1;//     0     1     0     1     1     0     0     1     0     0     0     0     1     0
	H[1][8] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[1][9] = 1;//     0     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[1][10] = 0;//     1     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[1][11] = 0;//     0     1     0     0     0     0     0     0     0     0     0     0     0     0
	H[1][12] = 0;//     0     0     1     0     0     0     0     0     0     0     0     0     0     0
	H[1][13] = 0;//     0     0     0     1     0     0     0     0     0     0     0     0     0     0
	H[1][14] = 0;//     0     0     0     0     1     0     0     0     0     0     0     0     0     0
	H[1][15] = 0;//     0     0     0     0     0     1     0     0     0     0     0     0     0     0
	H[1][16] = 0;//     0     0     0     0     0     0     1     0     0     0     0     0     0     0
	H[1][17] = 0;//     0     0     0     0     0     0     0     1     0     0     0     0     0     0
	H[1][18] = 0;//     0     0     0     0     0     0     0     0     1     0     0     0     0     0
	H[1][19] = 0;//     0     0     0     0     0     0     0     0     0     1     0     0     0     0
	H[1][20] = 0;//     0     0     0     0     0     0     0     0     0     0     1     0     0     0
	H[1][21] = 0;//     0     0     0     0     0     0     0     0     0     0     0     1     0     0
	H[1][22] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     1     0
	H[1][23] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     0     1

	H[2][0] = 0;//     0     1     0     0     0     0     0     0     1     0     0     0     0
	H[2][1] = 0;//     1     0     0     1     0     0     1     0     0     1     0     0     0
	H[2][2] = 0;//     0     0     0     1     0     0     0     0     0     0     0     0     1
	H[2][3] = 0;//     0     0     1     0     1     0     0     1     0     1     0     0     0
	H[2][4] = 1;//     1     0     0     0     0     0     0     1     1     1     0     0     0
	H[2][5] = 0;//     0     0     0     0     1     1     0     0     1     0     0     0     0
	H[2][6] = 0;//     0     0     1     0     0     0     1     0     0     0     1     0     1
	H[2][7] = 0;//     1     0     1     1     0     0     1     0     0     0     0     1     0
	H[2][8] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[2][9] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[2][10] = 1;//     0     0     0     0     0     0     0     0     0     0     0     0     0
	H[2][11] = 0;//     1     0     0     0     0     0     0     0     0     0     0     0     0
	H[2][12] = 0;//     0     1     0     0     0     0     0     0     0     0     0     0     0
	H[2][13] = 0;//     0     0     1     0     0     0     0     0     0     0     0     0     0
	H[2][14] = 0;//     0     0     0     1     0     0     0     0     0     0     0     0     0
	H[2][15] = 0;//     0     0     0     0     1     0     0     0     0     0     0     0     0
	H[2][16] = 0;//     0     0     0     0     0     1     0     0     0     0     0     0     0
	H[2][17] = 0;//     0     0     0     0     0     0     1     0     0     0     0     0     0
	H[2][18] = 0;//     0     0     0     0     0     0     0     1     0     0     0     0     0
	H[2][19] = 0;//     0     0     0     0     0     0     0     0     1     0     0     0     0
	H[2][20] = 0;//     0     0     0     0     0     0     0     0     0     1     0     0     0
	H[2][21] = 0;//     0     0     0     0     0     0     0     0     0     0     1     0     0
	H[2][22] = 0;//     0     0     0     0     0     0     0     0     0     0     0     1     0
	H[2][23] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0     1

	H[3][0] = 0;//     1     0     0     0     0     0     0     1     0     0     0     0
	H[3][1] = 1;//     0     0     1     0     0     1     0     0     1     0     0     0
	H[3][2] = 0;//     0     0     1     0     0     0     0     0     0     0     0     1
	H[3][3] = 0;//     0     1     0     1     0     0     1     0     1     0     0     0
	H[3][4] = 1;//     0     0     0     0     0     0     1     1     1     0     0     0
	H[3][5] = 0;//     0     0     0     1     1     0     0     1     0     0     0     0
	H[3][6] = 0;//     0     1     0     0     0     1     0     0     0     1     0     1
	H[3][7] = 1;//     0     1     1     0     0     1     0     0     0     0     1     0
	H[3][8] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0
	H[3][9] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0
	H[3][10] = 0;//     0     0     0     0     0     0     0     0     0     0     0     0
	H[3][11] = 1;//     0     0     0     0     0     0     0     0     0     0     0     0
	H[3][12] = 0;//     1     0     0     0     0     0     0     0     0     0     0     0
	H[3][13] = 0;//     0     1     0     0     0     0     0     0     0     0     0     0
	H[3][14] = 0;//     0     0     1     0     0     0     0     0     0     0     0     0
	H[3][15] = 0;//     0     0     0     1     0     0     0     0     0     0     0     0
	H[3][16] = 0;//     0     0     0     0     1     0     0     0     0     0     0     0
	H[3][17] = 0;//     0     0     0     0     0     1     0     0     0     0     0     0
	H[3][18] = 0;//     0     0     0     0     0     0     1     0     0     0     0     0
	H[3][19] = 0;//     0     0     0     0     0     0     0     1     0     0     0     0
	H[3][20] = 0;//     0     0     0     0     0     0     0     0     1     0     0     0
	H[3][21] = 0;//     0     0     0     0     0     0     0     0     0     1     0     0
	H[3][22] = 0;//     0     0     0     0     0     0     0     0     0     0     1     0
	H[3][23] = 0;//     0     0     0     0     0     0     0     0     0     0     0     1

	H[4][0] = 1;//     0     0     0     0     0     0     1     0     0     0     0
	H[4][1] = 0;//     0     1     0     0     1     0     0     1     0     0     0
	H[4][2] = 0;//     0     1     0     0     0     0     0     0     0     0     1
	H[4][3] = 0;//     1     0     1     0     0     1     0     1     0     0     0
	H[4][4] = 0;//     0     0     0     0     0     1     1     1     0     0     0
	H[4][5] = 0;//     0     0     1     1     0     0     1     0     0     0     0
	H[4][6] = 0;//     1     0     0     0     1     0     0     0     1     0     1
	H[4][7] = 0;//     1     1     0     0     1     0     0     0     0     1     0
	H[4][8] = 0;//     0     0     0     0     0     0     0     0     0     0     0
	H[4][9] = 0;//     0     0     0     0     0     0     0     0     0     0     0
	H[4][10] = 0;//     0     0     0     0     0     0     0     0     0     0     0
	H[4][11] = 0;//     0     0     0     0     0     0     0     0     0     0     0
	H[4][12] = 1;//     0     0     0     0     0     0     0     0     0     0     0
	H[4][13] = 0;//     1     0     0     0     0     0     0     0     0     0     0
	H[4][14] = 0;//     0     1     0     0     0     0     0     0     0     0     0
	H[4][15] = 0;//     0     0     1     0     0     0     0     0     0     0     0
	H[4][16] = 0;//     0     0     0     1     0     0     0     0     0     0     0
	H[4][17] = 0;//     0     0     0     0     1     0     0     0     0     0     0
	H[4][18] = 0;//     0     0     0     0     0     1     0     0     0     0     0
	H[4][19] = 0;//     0     0     0     0     0     0     1     0     0     0     0
	H[4][20] = 0;//     0     0     0     0     0     0     0     1     0     0     0
	H[4][21] = 0;//     0     0     0     0     0     0     0     0     1     0     0
	H[4][22] = 0;//     0     0     0     0     0     0     0     0     0     1     0
	H[4][23] = 0;//     0     0     0     0     0     0     0     0     0     0     1

	H[5][0] = 0;//     0     0     0     0     0     1     0     0     0     0
	H[5][1] = 0;//     1     0     0     1     0     0     1     0     0     0
	H[5][2] = 0;//     1     0     0     0     0     0     0     0     0     1
	H[5][3] = 1;//     0     1     0     0     1     0     1     0     0     0
	H[5][4] = 0;//     0     0     0     0     1     1     1     0     0     0
	H[5][5] = 0;//     0     1     1     0     0     1     0     0     0     0
	H[5][6] = 1;//     0     0     0     1     0     0     0     1     0     1
	H[5][7] = 1;//     1     0     0     1     0     0     0     0     1     0
	H[5][8] = 0;//     0     0     0     0     0     0     0     0     0     0
	H[5][9] = 0;//     0     0     0     0     0     0     0     0     0     0
	H[5][10] = 0;//     0     0     0     0     0     0     0     0     0     0
	H[5][11] = 0;//     0     0     0     0     0     0     0     0     0     0
	H[5][12] = 0;//     0     0     0     0     0     0     0     0     0     0
	H[5][13] = 1;//     0     0     0     0     0     0     0     0     0     0
	H[5][14] = 0;//     1     0     0     0     0     0     0     0     0     0
	H[5][15] = 0;//     0     1     0     0     0     0     0     0     0     0
	H[5][16] = 0;//     0     0     1     0     0     0     0     0     0     0
	H[5][17] = 0;//     0     0     0     1     0     0     0     0     0     0
	H[5][18] = 0;//     0     0     0     0     1     0     0     0     0     0
	H[5][19] = 0;//     0     0     0     0     0     1     0     0     0     0
	H[5][20] = 0;//     0     0     0     0     0     0     1     0     0     0
	H[5][21] = 0;//     0     0     0     0     0     0     0     1     0     0
	H[5][22] = 0;//     0     0     0     0     0     0     0     0     1     0
	H[5][23] = 0;//     0     0     0     0     0     0     0     0     0     1

	H[6][0] = 0;//     0     0     0     0     1     0     0     0     0
	H[6][1] = 1;//     0     0     1     0     0     1     0     0     0
	H[6][2] = 1;//     0     0     0     0     0     0     0     0     1
	H[6][3] = 0;//     1     0     0     1     0     1     0     0     0
	H[6][4] = 0;//     0     0     0     1     1     1     0     0     0
	H[6][5] = 0;//     1     1     0     0     1     0     0     0     0
	H[6][6] = 0;//     0     0     1     0     0     0     1     0     1
	H[6][7] = 1;//     0     0     1     0     0     0     0     1     0
	H[6][8] = 0;//     0     0     0     0     0     0     0     0     0
	H[6][9] = 0;//     0     0     0     0     0     0     0     0     0
	H[6][10] = 0;//     0     0     0     0     0     0     0     0     0
	H[6][11] = 0;//     0     0     0     0     0     0     0     0     0
	H[6][12] = 0;//     0     0     0     0     0     0     0     0     0
	H[6][13] = 0;//     0     0     0     0     0     0     0     0     0
	H[6][14] = 1;//     0     0     0     0     0     0     0     0     0
	H[6][15] = 0;//     1     0     0     0     0     0     0     0     0
	H[6][16] = 0;//     0     1     0     0     0     0     0     0     0
	H[6][17] = 0;//     0     0     1     0     0     0     0     0     0
	H[6][18] = 0;//     0     0     0     1     0     0     0     0     0
	H[6][19] = 0;//     0     0     0     0     1     0     0     0     0
	H[6][20] = 0;//     0     0     0     0     0     1     0     0     0
	H[6][21] = 0;//     0     0     0     0     0     0     1     0     0
	H[6][22] = 0;//     0     0     0     0     0     0     0     1     0
	H[6][23] = 0;//     0     0     0     0     0     0     0     0     1

	H[7][0] = 0;//     0     0     0     1     0     0     0     0
	H[7][1] = 0;//     0     1     0     0     1     0     0     0
	H[7][2] = 0;//     0     0     0     0     0     0     0     1
	H[7][3] = 1;//     0     0     1     0     1     0     0     0
	H[7][4] = 0;//     0     0     1     1     1     0     0     0
	H[7][5] = 1;//     1     0     0     1     0     0     0     0
	H[7][6] = 0;//     0     1     0     0     0     1     0     1
	H[7][7] = 0;//     0     1     0     0     0     0     1     0
	H[7][8] = 0;//     0     0     0     0     0     0     0     0
	H[7][9] = 0;//     0     0     0     0     0     0     0     0
	H[7][10] = 0;//     0     0     0     0     0     0     0     0
	H[7][11] = 0;//     0     0     0     0     0     0     0     0
	H[7][12] = 0;//     0     0     0     0     0     0     0     0
	H[7][13] = 0;//     0     0     0     0     0     0     0     0
	H[7][14] = 0;//     0     0     0     0     0     0     0     0
	H[7][15] = 1;//     0     0     0     0     0     0     0     0
	H[7][16] = 0;//     1     0     0     0     0     0     0     0
	H[7][17] = 0;//     0     1     0     0     0     0     0     0
	H[7][18] = 0;//     0     0     1     0     0     0     0     0
	H[7][19] = 0;//     0     0     0     1     0     0     0     0
	H[7][20] = 0;//     0     0     0     0     1     0     0     0
	H[7][21] = 0;//     0     0     0     0     0     1     0     0
	H[7][22] = 0;//     0     0     0     0     0     0     1     0
	H[7][23] = 0;//     0     0     0     0     0     0     0     1

	H[8][0] = 0;//     0     0     1     0     0     0     0
	H[8][1] = 0;//     1     0     0     1     0     0     0
	H[8][2] = 0;//     0     0     0     0     0     0     1
	H[8][3] = 0;//     0     1     0     1     0     0     0
	H[8][4] = 0;//     0     1     1     1     0     0     0
	H[8][5] = 1;//     0     0     1     0     0     0     0
	H[8][6] = 0;//     1     0     0     0     1     0     1
	H[8][7] = 0;//     1     0     0     0     0     1     0
	H[8][8] = 0;//     0     0     0     0     0     0     0
	H[8][9] = 0;//     0     0     0     0     0     0     0
	H[8][10] = 0;//     0     0     0     0     0     0     0
	H[8][11] = 0;//     0     0     0     0     0     0     0
	H[8][12] = 0;//     0     0     0     0     0     0     0
	H[8][13] = 0;//     0     0     0     0     0     0     0
	H[8][14] = 0;//     0     0     0     0     0     0     0
	H[8][15] = 0;//     0     0     0     0     0     0     0
	H[8][16] = 1;//     0     0     0     0     0     0     0
	H[8][17] = 0;//     1     0     0     0     0     0     0
	H[8][18] = 0;//     0     1     0     0     0     0     0
	H[8][19] = 0;//     0     0     1     0     0     0     0
	H[8][20] = 0;//     0     0     0     1     0     0     0
	H[8][21] = 0;//     0     0     0     0     1     0     0
	H[8][22] = 0;//     0     0     0     0     0     1     0
	H[8][23] = 0;//     0     0     0     0     0     0     1

	H[9][0] = 0;//     0     1     0     0     0     0
	H[9][1] = 1;//     0     0     1     0     0     0
	H[9][2] = 0;//     0     0     0     0     0     1
	H[9][3] = 0;//     1     0     1     0     0     0
	H[9][4] = 0;//     1     1     1     0     0     0
	H[9][5] = 0;//     0     1     0     0     0     0
	H[9][6] = 1;//     0     0     0     1     0     1
	H[9][7] = 1;//     0     0     0     0     1     0
	H[9][8] = 0;//     0     0     0     0     0     0
	H[9][9] = 0;//     0     0     0     0     0     0
	H[9][10] = 0;//     0     0     0     0     0     0
	H[9][11] = 0;//     0     0     0     0     0     0
	H[9][12] = 0;//     0     0     0     0     0     0
	H[9][13] = 0;//     0     0     0     0     0     0
	H[9][14] = 0;//     0     0     0     0     0     0
	H[9][15] = 0;//     0     0     0     0     0     0
	H[9][16] = 0;//     0     0     0     0     0     0
	H[9][17] = 1;//     0     0     0     0     0     0
	H[9][18] = 0;//     1     0     0     0     0     0
	H[9][19] = 0;//     0     1     0     0     0     0
	H[9][20] = 0;//     0     0     1     0     0     0
	H[9][21] = 0;//     0     0     0     1     0     0
	H[9][22] = 0;//     0     0     0     0     1     0
	H[9][23] = 0;//     0     0     0     0     0     1

	H[10][0] = 0;//     1     0     0     0     0
	H[10][1] = 0;//     0     1     0     0     0
	H[10][2] = 0;//     0     0     0     0     1
	H[10][3] = 1;//     0     1     0     0     0
	H[10][4] = 1;//     1     1     0     0     0
	H[10][5] = 0;//     1     0     0     0     0
	H[10][6] = 0;//     0     0     1     0     1
	H[10][7] = 0;//     0     0     0     1     0
	H[10][8] = 0;//     0     0     0     0     0
	H[10][9] = 0;//     0     0     0     0     0
	H[10][10] = 0;//     0     0     0     0     0
	H[10][11] = 0;//     0     0     0     0     0
	H[10][12] = 0;//     0     0     0     0     0
	H[10][13] = 0;//     0     0     0     0     0
	H[10][14] = 0;//     0     0     0     0     0
	H[10][15] = 0;//     0     0     0     0     0
	H[10][16] = 0;//     0     0     0     0     0
	H[10][17] = 0;//     0     0     0     0     0
	H[10][18] = 1;//     0     0     0     0     0
	H[10][19] = 0;//     1     0     0     0     0
	H[10][20] = 0;//     0     1     0     0     0
	H[10][21] = 0;//     0     0     1     0     0
	H[10][22] = 0;//     0     0     0     1     0
	H[10][23] = 0;//     0     0     0     0     1

	H[11][0] = 1;//     0     0     0     0
	H[11][1] = 0;//     1     0     0     0
	H[11][2] = 0;//     0     0     0     1
	H[11][3] = 0;//     1     0     0     0
	H[11][4] = 1;//     1     0     0     0
	H[11][5] = 1;//     0     0     0     0
	H[11][6] = 0;//     0     1     0     1
	H[11][7] = 0;//     0     0     1     0
	H[11][8] = 0;//     0     0     0     0
	H[11][9] = 0;//     0     0     0     0
	H[11][10] = 0;//     0     0     0     0
	H[11][11] = 0;//     0     0     0     0
	H[11][12] = 0;//     0     0     0     0
	H[11][13] = 0;//     0     0     0     0
	H[11][14] = 0;//     0     0     0     0
	H[11][15] = 0;//     0     0     0     0
	H[11][16] = 0;//     0     0     0     0
	H[11][17] = 0;//     0     0     0     0
	H[11][18] = 0;//     0     0     0     0
	H[11][19] = 1;//     0     0     0     0
	H[11][20] = 0;//     1     0     0     0
	H[11][21] = 0;//     0     1     0     0
	H[11][22] = 0;//     0     0     1     0
	H[11][23] = 0;//     0     0     0     1

	H[12][0] = 0;//     0     0     0
	H[12][1] = 1;//     0     0     0
	H[12][2] = 0;//     0     0     1
	H[12][3] = 1;//     0     0     0
	H[12][4] = 1;//     0     0     0
	H[12][5] = 0;//     0     0     0
	H[12][6] = 0;//     1     0     1
	H[12][7] = 0;//     0     1     0
	H[12][8] = 0;//     0     0     0
	H[12][9] = 0;//     0     0     0
	H[12][10] = 0;//     0     0     0
	H[12][11] = 0;//     0     0     0
	H[12][12] = 0;//     0     0     0
	H[12][13] = 0;//     0     0     0
	H[12][14] = 0;//     0     0     0
	H[12][15] = 0;//     0     0     0
	H[12][16] = 0;//     0     0     0
	H[12][17] = 0;//     0     0     0
	H[12][18] = 0;//     0     0     0
	H[12][19] = 0;//     0     0     0
	H[12][20] = 1;//     0     0     0
	H[12][21] = 0;//     1     0     0
	H[12][22] = 0;//     0     1     0
	H[12][23] = 0;//     0     0     1

	H[13][0] = 0;//     0     0
	H[13][1] = 0;//     0     0
	H[13][2] = 0;//     0     1
	H[13][3] = 0;//     0     0
	H[13][4] = 0;//     0     0
	H[13][5] = 0;//     0     0
	H[13][6] = 1;//     0     1
	H[13][7] = 0;//     1     0
	H[13][8] = 0;//     0     0
	H[13][9] = 0;//     0     0
	H[13][10] = 0;//     0     0
	H[13][11] = 0;//     0     0
	H[13][12] = 0;//     0     0
	H[13][13] = 0;//     0     0
	H[13][14] = 0;//     0     0
	H[13][15] = 0;//     0     0
	H[13][16] = 0;//     0     0
	H[13][17] = 0;//     0     0
	H[13][18] = 0;//     0     0
	H[13][19] = 0;//     0     0
	H[13][20] = 0;//     0     0
	H[13][21] = 1;//     0     0
	H[13][22] = 0;//     1     0
	H[13][23] = 0;//     0     1

	H[14][0] = 0;//     0
	H[14][1] = 0;//     0
	H[14][2] = 0;//     1
	H[14][3] = 0;//     0
	H[14][4] = 0;//     0
	H[14][5] = 0;//     0
	H[14][6] = 0;//     1
	H[14][7] = 1;//     0
	H[14][8] = 0;//     0
	H[14][9] = 0;//     0
	H[14][10] = 0;//     0
	H[14][11] = 0;//     0
	H[14][12] = 0;//     0
	H[14][13] = 0;//     0
	H[14][14] = 0;//     0
	H[14][15] = 0;//     0
	H[14][16] = 0;//     0
	H[14][17] = 0;//     0
	H[14][18] = 0;//     0
	H[14][19] = 0;//     0
	H[14][20] = 0;//     0
	H[14][21] = 0;//     0
	H[14][22] = 1;//     0
	H[14][23] = 0;//     1

	H[15][0] = 0;//
	H[15][1] = 0;//
	H[15][2] = 1;//
	H[15][3] = 0;//
	H[15][4] = 0;//
	H[15][5] = 0;//
	H[15][6] = 1;//
	H[15][7] = 0;//
	H[15][8] = 0;//
	H[15][9] = 0;//
	H[15][10] = 0;//
	H[15][11] = 0;//
	H[15][12] = 0;//
	H[15][13] = 0;//
	H[15][14] = 0;//
	H[15][15] = 0;//
	H[15][16] = 0;//
	H[15][17] = 0;//
	H[15][18] = 0;//
	H[15][19] = 0;//
	H[15][20] = 0;//
	H[15][21] = 0;//
	H[15][22] = 0;//
	H[15][23] = 1;//


	// calculate stuff about H
	prep_once();
}


LDPC::~LDPC()
{


}

void LDPC::print_h()
{
	cout << "H = " << endl;
	for( unsigned i = 0; i < h_rows; ++i )
	{
		for( unsigned j = 0; j < h_cols; ++j)
		{
			cout << H[i][j] << ",";
		}
		cout << endl;
	}
	cout << endl;
}

void LDPC::prep_once()
{
	// calculate degree for each check node, fill in node_index
	for( unsigned i = 0; i < h_rows; ++i )
	{
		m[i].degree = 0;
		for( unsigned j = 0; j < h_cols; ++j)
		{
			if( H[i][j] )
			{
				// keep track of the index of which variable nodes this check node is connected to
				m[i].node_index[m[i].degree] = j;
				m[i].degree++;
			}
		}

		//		cout << "Check node " << i << " has degree " << m[i].degree << endl;
	}
}

void LDPC::calc_syndrome(void)
{
	unsigned print = 1;

	for( unsigned i = 0; i < h_rows; ++i )
	{
		if( print ) cout << "equation (" << i << ") = ";
		LDPC_M *mi = &(m[i]);

		mi->parity = 0;

		for( unsigned j = 0; j < mi->degree; ++j)
		{
			int node_index = mi->node_index[j];
			LDPC_N *ni = &(n[node_index]);

			short val = ( ni->llr < 0 ) ? 1 : 0;

			if( print && j != 0 ) cout << " ^ ";
			if( print ) cout << val;

			mi->parity = val ^ mi->parity;
		}

		if( print ) cout << " = " << mi->parity << endl;
	}
}

// technically returns the sum of the syndrome
unsigned LDPC::get_syndrome(void)
{
	unsigned syndrome = 0;  // "And IncrediBoy!!"

	for( unsigned i = 0; i < h_rows; ++i )
	{
		syndrome += m[i].parity;
	}

	return syndrome;
}

void LDPC::iteration()
{
	// Load up min 1,2.  This is the Q message stage
	for( unsigned i = 0; i < h_rows; ++i )
	{
		LDPC_M *mi = &(m[i]);
		LDPC_N *ni = &(n[mi->node_index[0]]);
		LDPC_N *ni_next = &(n[mi->node_index[1]]);

		// cook first two iterations of loop below
		if( std::abs(ni->llr) < abs(ni_next->llr) )
		{
			mi->min[0]       = ni->llr;
			mi->min_index[0] = mi->node_index[0];

			mi->min[1]       = ni_next->llr;
			mi->min_index[1] = mi->node_index[1];
		}
		else
		{
			mi->min[1]       = ni->llr;
			mi->min_index[1] = mi->node_index[0];

			mi->min[0]       = ni_next->llr;
			mi->min_index[0] = mi->node_index[1];
		}

		// start at 2
		for( unsigned j = 2; j < mi->degree; ++j)
		{
			int node_index = mi->node_index[j];
			ni = &(n[node_index]);

			if( abs(ni->llr) < abs(mi->min[0]) )
			{
				// this is the smallest yet.  bump the previous smallest to 2nd smallest
				mi->min[1] = mi->min[0];
				mi->min_index[1] = mi->min_index[0];

				// and assign
				mi->min[0] = ni->llr;
				mi->min_index[0] = node_index;
			}
			else if( abs(ni->llr) < abs(mi->min[1]) )
			{
				// this is only smaller than the 2nd smallest, simply assign
				mi->min[1] = ni->llr;
				mi->min_index[1] = node_index;
			}
		}
	}


	// we can't modify n array directly because we assume the sign of llr on variable nodes stays the same throughout the whole loop
	float additions[h_cols];

	for( unsigned j = 0; j < h_cols; ++j )
		additions[j] = 0;

	// Pass R messages
	for( unsigned i = 0; i < h_rows; ++i )
	{
		LDPC_M *mi = &(m[i]);

		for( unsigned j = 0; j < mi->degree; ++j)
		{
			int node_index = mi->node_index[j];
			LDPC_N *ni = &(n[node_index]);

			int val;

			// due to the exclusive property, check nodes alter the llr of variable nodes using all connected variable nodes except for the one being modified
			if( node_index == mi->min_index[0] )
			{
				val = abs(mi->min[1]);
			}
			else
			{
				val = abs(mi->min[0]);
			}

			int sign = ( ni->llr < 0 ) ? -1 : 1;

			if( mi->parity )
			{
				// parity is failing, flip the bit
				sign *= -1;
			}
			else
			{
				// parity is ok, push the variable node stronger in it's current direction
				// don't flip sign
			}

			additions[node_index] += sign*val;
		}
	}

	// apply additions all at once
	for( unsigned j = 0; j < h_cols; ++j )
	{
		LDPC_N *ni = &(n[j]);
		ni->llr += additions[j];
	}

}

void LDPC::get_message()
{

	cout << "Assuming that the syndrome is 0, the message is: " << endl;

	int degreek = h_cols - h_rows;

	for( unsigned j = 0; j <= degreek; ++j )
	{
		LDPC_N *ni = &(n[j]);

		short val;
		if( ni->llr < 0 )
		{
			val = 1;
		}
		else
		{
			val = 0;
		}

		cout << val << endl;

	}

}

void LDPC::print_cw()
{
	cout << "Code word at this stage: " << endl;
	unsigned i;
	for(i = 0; i < 24; i++)
	{
		char c;
		c = n[i].llr < 0 ? '1' : '0';
		cout << c << endl;
	}

	cout << endl;
}


// this example is was pulled from Dropbox\popwi-general\docs\resources\ldpc\LDPC Soft Message Passing Decoder - Module1 Flash Memory Summit 2014.pdf

void LDPC::run()
{
	print_h();

	// Load data in step (This is Channel to bit message "L")

	// positive is 0
	// negative represents a 1

	// example 1 from slides
//	n[0].llr = -9;
//	n[1].llr = +7;
//	n[2].llr = -12;
//	n[3].llr = +4;
//	n[4].llr = +7;
//	n[5].llr = +10;
//	n[6].llr = -11;
//
//	// example 2 from slides
//	n[0].llr = -9;
//	n[1].llr = -7;
//	n[2].llr = -12;
//	n[3].llr = -4;
//	n[4].llr = +7;
//	n[5].llr = +10;
//	n[6].llr = -11;

	n[0].llr = 4161 * -1;
	n[1].llr = 5953 * -1;
	n[2].llr = -9328 * -1;
	n[3].llr = 0 * -1;
	n[4].llr = -1188 * -1;
	n[5].llr = 0 * -1;
	n[6].llr = -1144 * -1;
	n[7].llr = 0 * -1;
	n[8].llr = -3925 * -1;
	n[9].llr = 0 * -1;
	n[10].llr = -6833 * -1;
	n[11].llr = 9005 * -1;
	n[12].llr = -4161 * -1;
	n[13].llr = 7449 * -1;
	n[14].llr = 965 * -1;
	n[15].llr = -7030 * -1;
	n[16].llr = 0 * -1;
	n[17].llr = 0 * -1;
	n[18].llr = 0 * -1;
	n[19].llr = -1967 * -1;
	n[20].llr = 0 * -1;
	n[21].llr = 0 * -1;
	n[22].llr = -9328 * -1;
	n[23].llr = -3154 * -1;

	print_cw();

	// Do check
	calc_syndrome();
	get_syndrome();
	cout << endl;


	// iteration
	iteration();

	// Do check
	calc_syndrome();
	get_syndrome();
	cout << endl;


	// iteration
	iteration();

	// Do check
	calc_syndrome();
	get_syndrome();
	cout << endl;

	iteration();

	calc_syndrome();
	get_syndrome();

	print_cw();

	get_message();


}


}
